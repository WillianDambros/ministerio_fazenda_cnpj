anos <- lubridate::year(lubridate::today())
meses <- lubridate::month(lubridate::today()) - 1

# Combina os arquivos das duas categorias
arquivos_combinados <- list(
  list(tipo = "Empresas", nomes = c("Empresas", "Estabelecimentos", "Socios"),
       indices = 0:9),
  list(tipo = "Outros", nomes = c("Cnaes", "Motivos", "Municipios", "Naturezas",
                                  "Paises", "Qualificacoes", "Simples"),
       indices = NULL)
)

# Loop único
for (item in arquivos_combinados) {
  tipo <- item$tipo
  nomes <- item$nomes
  indices <- item$indices
  
  for (nome in nomes) {
    if (!is.null(indices)) {
      for (indice in indices) {
        curl::curl_download(
          paste0("https://arquivos.receitafederal.gov.br/",
                 "dados/cnpj/dados_abertos_cnpj/",
                 anos, "-", meses, "/", nome, indice, ".zip"),
          destfile = paste0("data/", anos, "_", meses, "_", nome, indice, ".zip")
        )
      }
    } else {
      curl::curl_download(
        paste0("https://arquivos.receitafederal.gov.br/",
               "dados/cnpj/dados_abertos_cnpj/",
               anos, "-", meses, "/", nome, ".zip"),
        destfile = paste0("data/", anos, "_", meses, "_", nome, ".zip")
      )
    }
  }
}


# adicionar trycath erro parecido com comexstat
# tentar verificar se é possivel criar pasta por ano para o exercicio ficar ano mes

setwd("data")

cnpj_empresas_enderecos <- fs::dir_ls(glob = "*Empresas*.zip")
cnpj_empresas_lista <- vector(mode = "list",
                              length = length(cnpj_empresas_enderecos))


for(i in seq_along(cnpj_empresas_enderecos)){
  cnpj_empresas_lista[[i]] <- readr::read_csv2(cnpj_empresas_enderecos[i],
                                             col_names = F,
                                             col_types = readr::cols(
                                               "X5" = readr::col_double(),
                                               .default = readr::col_character()
                                             ))
}

cnpj_empresa <- cnpj_empresas_lista |> dplyr::bind_rows() |> 
  dplyr::rename(cnpj_basico = 1,
                razao_social = 2,
                natureza_juridica = 3,
                qualificacao_responsavel = 4,
                capital_social_str = 5,
                porte_empresa = 6,
                ente_federativo_responsavel = 7)

rm(cnpj_empresas_lista)
